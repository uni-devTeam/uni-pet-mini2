<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/default_layout">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/content.css}">
</head>
<th:block layout:fragment="content">
    <body>
    <div th:replace="/fragments/topBackground.html :: topBgFragment(imgName='Board')"></div>
    <div id="entire_screen">
        <div class="container_nav">
            <nav class="nav_flex_column">
                <a class="nav-link" th:href="@{'/board/list' + 0}"><span class="bnav">ê³µì§€ ê²Œì‹œíŒ</span></a>
                <a class="nav-link" th:href="@{'/board/list' + 1}"><span class="bnav">ë‚˜ëˆ” ê²Œì‹œíŒ</span></a>
                <a class="nav-link" th:href="@{'/board/list' + 2}"><span class="bnav">ììœ  ê²Œì‹œíŒ</span></a>
            </nav>
        </div>
        <!--        <aside class="boardNav" th:insert="/boardnav.html :: navFragment"></aside>-->
        <section class="main_container">
            <div class="main_wrap">
                <h1 class="board_title" th:text="|${board.title}|"></h1>
                <!--<div class="posting_info1" th:text="|ï¸ğŸ˜${board.user_id}|"></div>-->
                <div class="writer_wrap">
                <img class="circle_pet" th:if="${pet_pic != null}" th:src="@{|${pet_pic}|}"
                     alt="Pet Image"/>
                <img class="circle_pet" th:unless="${pet_pic != null}"
                     th:src="@{/img/mypage/default-image.png}" alt="No Image"/>
                <div class="posting_info1" th:text="|ï¸${board.user_id}|"></div>
                </div>


                <div class="posting_info2" th:utext="|${board.posting_date} &amp;nbsp; ì¡°íšŒ ${board.views}|"></div>
                <hr>
                <h2>ê²Œì‹œê¸€ ë‚´ìš©</h2>
                <br>
                <div id="content" th:utext="|${board.content}|" style="font-size: larger"></div>
            </div>
            <br>
            <hr>

            <!--ëŒ“ê¸€ ì¶œë ¥ ë¶€ë¶„-->
            <div class="comment_list"
                 th:if="${(session.userId == 'admin' && board.board_id == 0) || board.board_id != 0}">
                <div class="reply_text_content">
                    <h2>ëŒ“ê¸€</h2>
                    <br>
                    <ul id='Comment_list'>
                        <li th:each="comment : ${comments}">
                            <div class="writer_wrap">
                            <img class="circle_pet" th:if="${comment.petPicUrl != null}" th:src="@{|${comment.petPicUrl}|}"
                                 alt="Pet Image"/>
                            <img class="circle_pet" th:unless="${comment.petPicUrl != null}"
                                 th:src="@{/img/mypage/default-image.png}" alt="No Image"/>
                            <!--<span th:text="|ï¸ğŸ™‚${comment.user_id}|"></span><br>-->
                            <span th:text="|ï¸${comment.user_id}|"></span>
                            </div>


                            <span th:text="${comment.content}"></span>
                            <hr>
                        </li>
                    </ul>
                </div>

                <!-- ëŒ“ê¸€ ì‘ì„± ë¶€ë¶„ -->
                <form id='reply_form' method='post' action="/board/comment"
                      th:if="${(session.userId == 'admin' && board.board_id == 0) || board.board_id != 0 && session.userId != null}">
                    <div class="comment_write">
                        <label for='commentContent' th:text="${session.userId}">ëŒ“ê¸€ ì‘ì„±ì ì•„ì´ë””</label><br/>
                        <textarea id='commentContent' name='content'
                                  placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”."></textarea><br/>
                        <input type="hidden" id="commentWriter" name="user_id" th:value="${session.userId}">
                        <input type="hidden" id="board_no" name="board_no" th:value="${board.board_no}"/>
                        <button id="comment_write_btn" class="btn btn-dark" onclick="commentWrite()">ë“±ë¡</button>
                    </div>
                </form>
            </div>

            <!-- ë²„íŠ¼ ë¬¶ìŒ -->
            <div class="button_wrap" th:if="${canEdit}">
                <!--th:if="${(session.userId == 'admin' && board.board_id == 0) || board.board_id != 0}"-->
                <a th:href="@{/}">
                    <button id="ref_btn" class="btn btn-dark">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                </a>
                <button id="edit_btn" class="btn btn-dark"
                        th:onclick="|displayUpdateForm(${board.board_no})|">ìˆ˜ì •
                </button>
                <a id="del_btn" class="btn btn-dark" th:href="@{'/board/delete?board_no='+${board.board_no}}"
                   onclick="return confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
            </div>

            <!-- ìˆ˜ì • form -->
            <div id="updateform" style="display: none">
                <h2 style="color: lightcoral">ê²Œì‹œê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”.</h2>
                <br>
                <form class="revise_form" method="post" action="/board/sbupdate">
                    <input type="hidden" name="board_no" value="">
                    <!--<input type="text" name="user_id" value="" required><br>-->

                    <textarea name="content" required style="height: 130px; padding: 10px;">

                    </textarea>
                    <div class="revision_btn">
                        <input id="revision_btn" type="submit" class="btn btn-danger" value="ìˆ˜ì •"
                               onclick="return confirm('ê²Œì‹œê¸€ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                        <input type="button" class="btn btn-danger" value="ì·¨ì†Œ"
                               onclick="document.getElementById('updateform').style.display='none'">
                    </div>
                </form>
            </div>
        </section>
    </div>

    <!--<script th:inline="javascript"></script> íƒ€ì„ë¦¬í”„ì—ì„œ ëª¨ë¸ì— ë‹´ê¸´ ê°’ì„ ì ‘ê·¼í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì¸ë° ê¼­ ì§€ì •í•´ì¤˜ì•¼ í•¨-->
    <script th:inline="javascript">
        let jsonobj = null;
        let user_iddom = null;
        let contentdom = null;

        function displayUpdateForm(board_no) {
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status == 200) {
                    document.getElementById('updateform').style.display = 'block';
                    let board_nodom = document.querySelector("#updateform input[name=board_no]");
                    /*user_iddom = document.querySelector("#updateform input[name=user_id]");*/
                    contentdom = document.querySelector("#updateform textarea");
                    jsonobj = JSON.parse(xhr.responseText);
                    board_nodom.value = jsonobj.board_no;
                    /* user_iddom.value = jsonobj.user_id;*/
                    // Create a temporary div element
                    let div = document.createElement('div');

                    // Set the innerHTML to the content from the server
                    div.innerHTML = jsonobj.content;

                    // Get only text from the created div element
                    let textOnlyContent = div.textContent;

                    board_nodom.value = jsonobj.board_no;
                    /* user_iddom.value=jsonobj.user_id;*/

                    // Use only text content to remove HTML tags.
                    contentdom.value = textOnlyContent;
                    /* contentdom.value = jsonobj.content;*/
                }
            };
            xhr.open('GET', '/board/parsejson?board_no=' + board_no, true);
            xhr.send();
        }

        /*        function resetForm() {
                    if (jsonobj) {
                        user_iddom.value = jsonobj.user_id;
                        contentdom.value = jsonobj.content;
                    }
                }*/

        //ëŒ“ê¸€ ë“±ë¡ js í•¨ìˆ˜
        const commentWrite = () => {
            const writer = document.getElementById("commentWriter").value;
            const contents = document.getElementById("commentContent").value;
            const boardNo = document.getElementById("board_no").value;
            console.log("ì‘ì„±ì: ", writer);
            console.log("ë‚´ìš©: ", contents);
            $.ajax({
                // ìš”ì²­ì£¼ì†Œ: /board/comment/save,ìš”ì²­ ë°©ì‹: post, ìš”ì²­ë°ì´í„°: ì‘ì„±ì, ì‘ì„±ë‚´ìš©, ê²Œì‹œê¸€ ë²ˆí˜¸
                url: "/comment/save",
                type: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "user_id": writer,
                    "content": contents,
                    "board_no": boardNo
                }),
                success: function (res) {
                    console.log(res);
                    let newComment = document.createElement("li");
                    newComment.innerHTML = `
                ì‘ì„±ì: ${res.comment.user_id}<br>
                ë‚´ìš©: ${res.comment.content}<br>
                <hr>
            `;
                    document.getElementById('reply_list').appendChild(newComment);
                },
                error: function (err) {
                    console.log("ìš”ì²­ ì‹¤íŒ¨", err);
                }
            });
        }
    </script>
    </body>
</th:block>
</html>
